# 项目配置文件模板

本文档包含微信小程序项目的所有配置文件模板，开发者需要根据实际环境填写相应的参数值。

## 1. 服务端配置 (config/server.json)

```json
{
  "server": {
    "port": 3000,
    "host": "0.0.0.0",
    "env": "production"
  },
  "database": {
    "host": "localhost",
    "port": 3306,
    "username": "factory_user",
    "password": "your_secure_password", 
    "database": "factory_management",
    "dialect": "mysql",
    "pool": {
      "max": 20,
      "min": 0,
      "acquire": 30000,
      "idle": 10000
    }
  },
  "wechat": {
    "appId": "your_wechat_appid",
    "appSecret": "your_wechat_app_secret",
    "mchId": "your_merchant_id",
    "apiKey": "your_api_key"
  },
  "aliyun": {
    "accessKeyId": "your_aliyun_access_key_id",
    "accessKeySecret": "your_aliyun_access_key_secret",
    "region": "cn-hangzhou",
    "oss": {
      "bucket": "your-oss-bucket-name",
      "endpoint": "oss-cn-hangzhou.aliyuncs.com"
    }
  },
  "redis": {
    "host": "your-redis-host",
    "port": 6379,
    "password": "your_redis_password",
    "db": 0
  },
  "jwt": {
    "secret": "your_jwt_secret_key",
    "expiresIn": "7d"
  },
  "systemAccess": {
    "enabled": true,
    "accessKey": "your_system_access_key",
    "accessSecret": "your_system_secret",
    "tokenExpiresIn": "24h",
    "allowedIPs": ["your.local.system.ip", "0.0.0.0"]
  },
  "upload": {
    "maxFileSize": "10MB",
    "allowedTypes": ["image/jpeg", "image/png", "image/gif"],
    "uploadPath": "/uploads"
  }
}
```

## 2. 微信小程序配置 (miniprogram/project.config.json)

```json
{
  "description": "版辊加工工厂管理小程序",
  "packOptions": {
    "ignore": []
  },
  "setting": {
    "urlCheck": false,
    "es6": true,
    "enhance": true,
    "postcss": true,
    "preloadBackgroundData": false,
    "minified": true,
    "newFeature": false,
    "coverView": true,
    "nodeModules": false,
    "autoAudits": false,
    "showShadowRootInWxmlPanel": true,
    "scopeDataCheck": false,
    "uglifyFileName": false,
    "checkInvalidKey": true,
    "checkSiteMap": true,
    "uploadWithSourceMap": true,
    "compileHotReLoad": false,
    "lazyloadPlaceholderEnable": false,
    "useMultiFrameRuntime": true,
    "useApiHook": true,
    "useApiHostProcess": true,
    "babelSetting": {
      "ignore": [],
      "disablePlugins": [],
      "outputPath": ""
    },
    "enableEngineNative": false,
    "useIsolateContext": true,
    "userConfirmedBundleSwitch": false,
    "packNpmManually": false,
    "packNpmRelationList": [],
    "minifyWXSS": true
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "appid": "your_wechat_appid",
  "projectname": "factory-management",
  "debugOptions": {
    "hidedInDevtools": []
  },
  "scripts": {},
  "staticServerOptions": {
    "baseURL": "",
    "servePath": ""
  },
  "isGameTourist": false,
  "condition": {
    "search": {
      "list": []
    },
    "conversation": {
      "list": []
    },
    "game": {
      "list": []
    },
    "plugin": {
      "list": []
    },
    "gamePlugin": {
      "list": []
    },
    "miniprogram": {
      "list": []
    }
  }
}
```

## 3. 小程序应用配置 (miniprogram/app.json)

```json
{
  "pages": [
    "pages/index/index",
    "pages/login/login", 
    "pages/worker/worker",
    "pages/scan/scan",
    "pages/admin/admin",
    "pages/products/products",
    "pages/processes/processes",
    "pages/employees/employees",
    "pages/contracts/contracts",
    "pages/statistics/statistics",
    "pages/profile/profile"
  ],
  "window": {
    "backgroundTextStyle": "dark",
    "navigationBarBackgroundColor": "#1890ff",
    "navigationBarTitleText": "工厂管理系统",
    "navigationBarTextStyle": "white",
    "enablePullDownRefresh": true
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1890ff",
    "backgroundColor": "#ffffff",
    "borderStyle": "white",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/home.png",
        "selectedIconPath": "images/home-active.png"
      },
      {
        "pagePath": "pages/worker/worker", 
        "text": "工作台",
        "iconPath": "images/work.png",
        "selectedIconPath": "images/work-active.png"
      },
      {
        "pagePath": "pages/scan/scan",
        "text": "扫码",
        "iconPath": "images/scan.png", 
        "selectedIconPath": "images/scan-active.png"
      },
      {
        "pagePath": "pages/profile/profile",
        "text": "我的",
        "iconPath": "images/profile.png",
        "selectedIconPath": "images/profile-active.png"
      }
    ]
  },
  "permission": {
    "scope.userLocation": {
      "desc": "您的位置信息将用于工厂签到定位"
    },
    "scope.camera": {
      "desc": "需要使用您的摄像头扫描二维码"
    }
  },
  "requiredBackgroundModes": ["location"],
  "networkTimeout": {
    "request": 10000,
    "downloadFile": 10000
  },
  "debug": false,
  "sitemapLocation": "sitemap.json"
}
```

## 4. API接口配置 (miniprogram/config/api.js)

```javascript
// API接口配置
const config = {
  // 开发环境
  development: {
    baseURL: 'http://localhost:3000/api',
    timeout: 10000
  },
  // 测试环境  
  testing: {
    baseURL: 'https://test-api.yourfactory.com/api',
    timeout: 10000
  },
  // 生产环境
  production: {
    baseURL: 'https://api.yourfactory.com/api', 
    timeout: 15000
  }
};

// 当前环境 - 请根据实际部署环境修改
const ENV = 'production';

module.exports = {
  ...config[ENV],
  // API端点配置
  endpoints: {
    // 用户相关
    login: '/auth/login',
    logout: '/auth/logout', 
    userInfo: '/user/info',
    
    // 工序相关
    processes: '/processes',
    completeProcess: '/processes/complete',
    userProcesses: '/processes/user',
    
    // 产品相关
    products: '/products',
    productTypes: '/product-types',
    
    // 合同相关
    contracts: '/contracts',
    contractProducts: '/contracts/:id/products',
    
    // 员工相关
    employees: '/employees',
    employeeBinding: '/employees/binding',
    
    // 绩效相关
    performance: '/performance',
    performanceStats: '/performance/stats',
    
    // 文件上传
    upload: '/upload',
    
    // 二维码相关
    qrcode: '/qrcode/generate'
  }
};
```

## 5. 数据库连接配置 (server/config/database.js)

**注意：本项目使用云主机本地安装的MySQL数据库**

```javascript
const config = require('./server.json');

module.exports = {
  development: {
    username: config.database.username,
    password: config.database.password,
    database: config.database.database + '_dev',
    host: config.database.host,
    port: config.database.port,
    dialect: config.database.dialect,
    pool: config.database.pool,
    logging: console.log
  },
  test: {
    username: config.database.username,
    password: config.database.password,
    database: config.database.database + '_test',
    host: config.database.host,
    port: config.database.port,
    dialect: config.database.dialect,
    pool: config.database.pool,
    logging: false
  },
  production: {
    username: config.database.username,
    password: config.database.password,
    database: config.database.database,
    host: config.database.host,
    port: config.database.port,
    dialect: config.database.dialect,
    pool: config.database.pool,
    logging: false,
    dialectOptions: {
      ssl: {
        require: true,
        rejectUnauthorized: false
      }
    }
  }
};
```

## 6. Nginx配置 (nginx/default.conf)

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/your-domain.crt;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # 现代SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;

    # 上传文件大小限制
    client_max_body_size 10M;

    # API代理
    location /api/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态文件
    location /uploads/ {
        alias /var/www/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

## 7. Docker配置 (Dockerfile)

```dockerfile
FROM node:16-alpine

# 设置工作目录
WORKDIR /app

# 安装依赖
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# 复制源代码
COPY . .

# 创建非root用户
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# 设置文件权限
RUN chown -R nodejs:nodejs /app
USER nodejs

# 暴露端口
EXPOSE 3000

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node healthcheck.js

# 启动应用
CMD ["npm", "start"]
```

## 8. Docker Compose配置 (docker-compose.yml)

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - factory-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - factory-network

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl
      - ./uploads:/var/www/uploads
    depends_on:
      - app
    restart: unless-stopped
    networks:
      - factory-network

volumes:
  redis-data:

networks:
  factory-network:
    driver: bridge
```

## 9. 环境变量配置 (.env)

```bash
# 应用配置
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# 数据库配置 (云主机本地MySQL)
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=factory_user
DB_PASSWORD=your_secure_password
DB_DATABASE=factory_management

# 微信小程序配置
WECHAT_APPID=your_wechat_appid
WECHAT_APP_SECRET=your_wechat_app_secret
WECHAT_MCH_ID=your_merchant_id
WECHAT_API_KEY=your_api_key

# 阿里云配置
ALIYUN_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_aliyun_access_key_secret
ALIYUN_REGION=cn-hangzhou
OSS_BUCKET=your-oss-bucket-name
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com

# Redis配置
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0

# JWT配置
JWT_SECRET=your_jwt_secret_key_here_make_it_long_and_secure
JWT_EXPIRES_IN=7d

# 本地系统访问配置
SYSTEM_ACCESS_KEY=your_system_access_key
SYSTEM_ACCESS_SECRET=your_system_secret
SYSTEM_TOKEN_EXPIRES_IN=24h

# 上传配置
MAX_FILE_SIZE=10485760
UPLOAD_PATH=/uploads

# 日志配置
LOG_LEVEL=info
LOG_FILE=./logs/app.log
```

## 配置文件说明

### 必需配置项
1. **数据库连接**: 必须配置正确的RDS连接信息
2. **微信小程序**: 需要在微信公众平台获取AppID和AppSecret
3. **阿里云服务**: 配置OSS存储和其他云服务访问密钥
4. **SSL证书**: 生产环境必须配置HTTPS证书

### 可选配置项
1. **Redis缓存**: 提高系统性能，建议配置
2. **日志级别**: 根据环境需要调整
3. **上传限制**: 根据业务需求调整文件大小限制

### 安全注意事项
1. 所有密码和密钥使用强随机字符串
2. 生产环境禁用调试模式
3. 定期更新SSL证书
4. 配置适当的防火墙规则

---

*请根据实际部署环境修改以上配置参数，确保系统安全稳定运行。*