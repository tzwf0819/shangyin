# 阿里云部署指南

## 部署概述

本文档详细说明如何在阿里云平台上部署版辊加工工厂管理系统，包括环境准备、服务配置、应用部署和监控运维等完整流程。

## 阿里云服务选型

### 1. 基础服务

| 服务名称 | 规格建议 | 用途说明 |
|----------|----------|----------|
| ECS云服务器 | ecs.c6.large (2核4G) | 应用服务器 |
| RDS MySQL | mysql.n2.small (1核2G) | 数据库服务 |
| Redis | redis.master.small (1核2G) | 缓存服务 |
| OSS对象存储 | 标准存储 | 文件存储 |
| CDN | 全球加速 | 静态资源加速 |
| SLB负载均衡 | slb.s1.small | 负载均衡 |
| SSL证书 | 免费版或商业版 | HTTPS支持 |

### 2. 可选服务

| 服务名称 | 用途说明 |
|----------|----------|
| VPC专有网络 | 网络隔离 |
| 安全组 | 访问控制 |
| 云监控 | 系统监控 |
| 日志服务SLS | 日志收集分析 |
| 短信服务 | 通知服务 |
| 弹性伸缩 | 自动扩容 |

## 环境准备

### 1. 创建阿里云账号

1. 注册阿里云账号：https://account.aliyun.com/
2. 完成实名认证
3. 开通所需服务
4. 设置访问密钥 (AccessKey)

### 2. 网络环境配置

#### 创建VPC网络
```bash
# 使用阿里云CLI创建VPC
aliyun ecs CreateVpc \
  --RegionId cn-hangzhou \
  --CidrBlock 172.16.0.0/16 \
  --VpcName factory-vpc \
  --Description "工厂管理系统VPC"
```

#### 创建交换机
```bash
# 创建Web层交换机
aliyun ecs CreateVSwitch \
  --RegionId cn-hangzhou \
  --ZoneId cn-hangzhou-h \
  --VpcId vpc-xxxxxxxxx \
  --CidrBlock 172.16.1.0/24 \
  --VSwitchName web-subnet

# 创建数据库层交换机  
aliyun ecs CreateVSwitch \
  --RegionId cn-hangzhou \
  --ZoneId cn-hangzhou-h \
  --VpcId vpc-xxxxxxxxx \
  --CidrBlock 172.16.2.0/24 \
  --VSwitchName db-subnet
```

#### 配置安全组规则
```bash
# 创建Web层安全组
aliyun ecs CreateSecurityGroup \
  --RegionId cn-hangzhou \
  --VpcId vpc-xxxxxxxxx \
  --SecurityGroupName web-sg \
  --Description "Web服务器安全组"

# 添加HTTP/HTTPS规则
aliyun ecs AuthorizeSecurityGroup \
  --RegionId cn-hangzhou \
  --SecurityGroupId sg-xxxxxxxxx \
  --IpProtocol tcp \
  --PortRange 80/80 \
  --SourceCidrIp 0.0.0.0/0

aliyun ecs AuthorizeSecurityGroup \
  --RegionId cn-hangzhou \
  --SecurityGroupId sg-xxxxxxxxx \
  --IpProtocol tcp \
  --PortRange 443/443 \
  --SourceCidrIp 0.0.0.0/0

# 添加SSH规则 (限制来源IP)
aliyun ecs AuthorizeSecurityGroup \
  --RegionId cn-hangzhou \
  --SecurityGroupId sg-xxxxxxxxx \
  --IpProtocol tcp \
  --PortRange 22/22 \
  --SourceCidrIp YOUR_IP/32
```

## 数据库部署

**重要说明**: 本项目使用云主机本地安装的MySQL数据库，不使用阿里云RDS服务。

### 1. 在ECS云服务器上安装MySQL 8.0

```bash
# 下载MySQL官方YUM仓库
wget https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm

# 安装YUM仓库  
rpm -ivh mysql80-community-release-el8-1.noarch.rpm

# 安装MySQL服务器
yum install -y mysql-server

# 启动MySQL服务
systemctl start mysqld
systemctl enable mysqld

# 获取初始密码
grep 'temporary password' /var/log/mysqld.log
```

### 2. 配置MySQL数据库

#### 安全配置和用户创建
```bash
# 运行MySQL安全配置
mysql_secure_installation

# 创建应用数据库和用户
mysql -u root -p << 'EOF'
-- 创建数据库
CREATE DATABASE factory_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建应用用户
CREATE USER 'factory_user'@'localhost' IDENTIFIED BY 'YourSecurePassword123!';

-- 授权
GRANT ALL PRIVILEGES ON factory_management.* TO 'factory_user'@'localhost';
FLUSH PRIVILEGES;
EOF
```

#### 导入数据库结构
```bash
# 导入数据库结构
mysql -u factory_user -p factory_management < database/schema.sql

# 导入初始数据
mysql -u factory_user -p factory_management < database/init_data.sql
```

#### 配置MySQL性能参数
```bash
# 编辑MySQL配置文件
vim /etc/my.cnf

# 添加性能优化配置
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
max_connections = 200
query_cache_size = 64M
```

### 3. 创建Redis缓存

#### 使用控制台创建
1. 登录阿里云Redis管理控制台
2. 创建实例 → Redis 6.0
3. 选择规格：redis.master.small (1核2G)
4. 网络：VPC网络，选择db-subnet交换机

#### 配置Redis连接
```bash
# 测试Redis连接
redis-cli -h your-redis-host -p 6379 -a your_redis_password
```

## 服务器部署

### 1. 创建ECS实例

#### 使用控制台创建
1. 登录阿里云ECS管理控制台
2. 创建实例 → CentOS 8.2 64位
3. 选择规格：ecs.c6.large (2核4G)
4. 网络：VPC网络，选择web-subnet交换机
5. 安全组：选择web-sg安全组
6. 系统盘：40GB SSD

#### 使用CLI创建
```bash
aliyun ecs RunInstances \
  --RegionId cn-hangzhou \
  --ImageId centos_8_2_x64_20G_alibase_20200914.vhd \
  --InstanceType ecs.c6.large \
  --SecurityGroupId sg-xxxxxxxxx \
  --VSwitchId vsw-xxxxxxxxx \
  --InternetMaxBandwidthOut 100 \
  --HostName factory-web-01 \
  --InstanceName factory-web-01 \
  --Password 'YourSecurePassword123!'
```

### 2. 服务器基础环境配置

#### 连接服务器并更新系统
```bash
# SSH连接到ECS实例
ssh root@your-ecs-public-ip

# 更新系统
yum update -y

# 安装基础工具
yum install -y wget curl git vim htop
```

#### 安装Node.js
```bash
# 安装Node.js 16.x
curl -fsSL https://rpm.nodesource.com/setup_16.x | bash -
yum install -y nodejs

# 验证安装
node --version
npm --version

# 安装PM2进程管理器
npm install -g pm2
```

#### 安装Nginx
```bash
# 安装Nginx
yum install -y nginx

# 启动并设置开机自启
systemctl start nginx
systemctl enable nginx

# 检查状态
systemctl status nginx
```

#### 安装Docker (可选)
```bash
# 安装Docker
yum install -y docker

# 启动Docker服务
systemctl start docker
systemctl enable docker

# 安装docker-compose
curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

### 3. 配置SSL证书

#### 申请免费SSL证书
1. 登录阿里云SSL证书控制台
2. 申请免费证书 → 填写域名信息
3. DNS验证 → 配置DNS记录
4. 下载证书文件

#### 配置Nginx SSL
```bash
# 创建SSL目录
mkdir -p /etc/nginx/ssl

# 上传证书文件到服务器
scp your-domain.crt root@your-ecs-ip:/etc/nginx/ssl/
scp your-domain.key root@your-ecs-ip:/etc/nginx/ssl/

# 设置证书文件权限
chmod 600 /etc/nginx/ssl/your-domain.key
chmod 644 /etc/nginx/ssl/your-domain.crt
```

## 应用部署

### 1. 部署后端应用

#### 准备应用代码
```bash
# 切换到应用目录
cd /var/www

# 克隆代码仓库 (或上传代码包)
git clone https://github.com/yourusername/factory-management-backend.git
cd factory-management-backend

# 安装依赖
npm install --production

# 复制并配置环境变量
cp .env.example .env
vim .env
```

#### 配置环境变量
```bash
# .env文件内容
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# 数据库配置
DB_HOST=your-rds-host.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_USERNAME=factory_user
DB_PASSWORD=your_secure_password
DB_DATABASE=factory_management

# 微信小程序配置
WECHAT_APPID=your_wechat_appid
WECHAT_APP_SECRET=your_wechat_app_secret

# 阿里云配置
ALIYUN_ACCESS_KEY_ID=your_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_access_key_secret
OSS_BUCKET=your-oss-bucket
OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com

# Redis配置
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your_redis_password

# JWT配置
JWT_SECRET=your_very_long_and_secure_jwt_secret_key_here
```

#### 使用PM2启动应用
```bash
# 创建PM2配置文件
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'factory-api',
    script: 'server.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
EOF

# 创建日志目录
mkdir -p logs

# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save

# 设置PM2开机自启
pm2 startup
```

### 2. 配置Nginx反向代理

#### 创建Nginx站点配置
```bash
cat > /etc/nginx/conf.d/factory.conf << 'EOF'
# 上游服务器配置
upstream factory_backend {
    server 127.0.0.1:3000;
    keepalive 64;
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS服务器配置
server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/your-domain.crt;
    ssl_certificate_key /etc/nginx/ssl/your-domain.key;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # 现代SSL配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header Strict-Transport-Security "max-age=63072000" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";

    # 上传文件大小限制
    client_max_body_size 10M;

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # API代理
    location /api/ {
        proxy_pass http://factory_backend/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态文件
    location /uploads/ {
        alias /var/www/factory-management-backend/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 健康检查
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
EOF

# 测试Nginx配置
nginx -t

# 重新加载Nginx配置
systemctl reload nginx
```

## OSS对象存储配置

### 1. 创建OSS Bucket

#### 使用控制台创建
1. 登录阿里云OSS管理控制台
2. 创建Bucket → 选择区域(杭州)
3. Bucket名称：your-factory-uploads
4. 读写权限：私有
5. 版本控制：关闭

#### 配置CORS
```json
[
  {
    "allowedOrigins": ["*"],
    "allowedMethods": ["GET", "POST", "PUT", "DELETE"],
    "allowedHeaders": ["*"],
    "exposeHeaders": ["ETag", "Content-MD5"],
    "maxAgeSeconds": 3600
  }
]
```

### 2. 配置CDN加速

#### 创建CDN域名
1. 登录阿里云CDN管理控制台
2. 添加域名 → 输入加速域名
3. 源站类型：OSS域名
4. 源站地址：选择OSS Bucket
5. 加速区域：中国大陆

#### CDN缓存配置
```bash
# 静态资源缓存规则
/uploads/*.jpg    30天
/uploads/*.png    30天  
/uploads/*.pdf    7天
/api/*           不缓存
```

## 监控和运维

### 1. 配置云监控

#### 创建监控大盘
1. 登录阿里云云监控控制台
2. 自定义监控 → 创建监控大盘
3. 添加监控图表：
   - ECS CPU使用率
   - ECS内存使用率
   - RDS连接数
   - Redis内存使用率
   - 应用响应时间

#### 设置报警规则
```bash
# CPU使用率超过80%报警
# 内存使用率超过85%报警  
# 磁盘使用率超过85%报警
# RDS连接数超过阈值报警
# 应用响应时间超过3秒报警
```

### 2. 日志管理

#### 配置日志收集
```bash
# 安装日志服务Agent
wget http://logtail-release-cn-hangzhou.oss-cn-hangzhou.aliyuncs.com/linux64/logtail.sh
chmod 755 logtail.sh
./logtail.sh install cn-hangzhou

# 配置应用日志收集
# 在SLS控制台配置Logstore和日志收集规则
```

### 3. 备份策略

#### 数据库备份脚本
```bash
#!/bin/bash
# /opt/scripts/backup_database.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
DB_HOST="your-rds-host.mysql.rds.aliyuncs.com"
DB_USER="factory_user"
DB_PASS="your_password"
DB_NAME="factory_management"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mysqldump -h$DB_HOST -u$DB_USER -p$DB_PASS \
  --single-transaction \
  --routines \
  --triggers \
  $DB_NAME > $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 压缩备份文件
gzip $BACKUP_DIR/${DB_NAME}_${DATE}.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete

# 上传到OSS
ossutil cp $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz oss://your-backup-bucket/mysql/

echo "备份完成: ${DB_NAME}_${DATE}.sql.gz"
```

#### 设置定时备份
```bash
# 设置crontab定时任务
crontab -e

# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup_database.sh >> /var/log/backup.log 2>&1
```

### 4. 安全加固

#### 系统安全配置
```bash
# 禁用root SSH登录
sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# 修改SSH端口(可选)
sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config

# 重启SSH服务
systemctl restart sshd

# 配置防火墙
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=2222/tcp
firewall-cmd --reload
```

#### 应用安全配置
```bash
# 设置应用文件权限
chown -R nginx:nginx /var/www/factory-management-backend
chmod -R 644 /var/www/factory-management-backend
chmod -R +X /var/www/factory-management-backend
chmod 600 /var/www/factory-management-backend/.env
```

## 性能优化

### 1. 数据库优化

#### MySQL配置优化
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# InnoDB配置
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 查询缓存
query_cache_type = 1
query_cache_size = 64M

# 连接数
max_connections = 200
max_connect_errors = 10000

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2
```

### 2. 应用层优化

#### Node.js应用优化
```javascript
// 启用gzip压缩
app.use(compression());

// 设置缓存头
app.use(express.static('uploads', {
  maxAge: '30d',
  etag: true,
  lastModified: true
}));

// 连接池配置
const pool = mysql.createPool({
  connectionLimit: 20,
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASS,
  database: process.env.DB_NAME,
  acquireTimeout: 60000,
  timeout: 60000
});
```

## 部署检查清单

### 部署前检查
- [ ] 阿里云账号和服务开通
- [ ] 域名备案和DNS解析配置
- [ ] SSL证书申请和配置
- [ ] 网络和安全组配置
- [ ] 数据库和缓存服务准备

### 部署后检查
- [ ] 应用服务正常启动
- [ ] 数据库连接正常
- [ ] 缓存服务正常
- [ ] SSL证书有效
- [ ] 域名解析正确
- [ ] 监控和日志配置
- [ ] 备份策略执行
- [ ] 性能测试通过

### 上线后验证
- [ ] 微信小程序功能测试
- [ ] API接口响应正常
- [ ] 用户登录和权限验证
- [ ] 文件上传和下载
- [ ] 二维码生成和扫描
- [ ] 数据统计和报表
- [ ] 系统性能和稳定性

---

*本部署指南提供了在阿里云平台部署版辊加工工厂管理系统的完整流程，确保系统安全、稳定、高效运行。*